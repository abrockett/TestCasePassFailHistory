<!DOCTYPE html>
<html>
<head>
    <title>TestCasePassFailHistory</title>

    <script type="text/javascript" src="/apps/x/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"mainHeader",componentCls:"header"},{xtype:"container",itemId:"testCaseGrids"}],launch:function(){var prevDate30=Rally.util.DateTime.add(new Date,"day",-30),isoPrevDate30=Rally.util.DateTime.toIsoString(prevDate30,!1);this.down("#mainHeader").update("Test case history for last 30 days:"),Ext.create("Rally.data.WsapiDataStore",{model:"TestCaseResult",autoLoad:!0,fetch:["ObjectID","Build","Date","Verdict","Duration","Tester","UserName","DisplayName","TestCase","FormattedID","Name","WorkProduct"],filters:[{property:"Date",operator:">=",value:isoPrevDate30}],sorters:[{property:"Date",direction:"DESC"}],listeners:{load:this._onTestCasesDataLoaded,scope:this}})},_conditionalGet:function(obj,str){return void 0===obj.get(str)?"":obj.get(str)},_testerIfKnown:function(testerObj){return"object"==typeof testerObj&&void 0!==testerObj.DisplayName?testerObj.DisplayName:"object"==typeof testerObj&&void 0!==testerObj.UserName?testerObj.UserName:""},_drawBox:function(verdict){var boxTemplate=new Ext.Template('<div class="{verdictClass}"><div style="margin:2px;">{verdict}</div></div>'),verdictClass="pass-legend-other";return"Pass"===verdict?verdictClass="pass-legend":"Fail"===verdict&&(verdictClass="pass-legend-fail"),boxTemplate.apply({verdictClass:verdictClass,verdict:verdict})},_organizeResultsByTestCase:function(testCaseResults){for(var testCaseHolder={},tcResult,testCase,id,i=0;testCaseResults.length>i;i++)tcResult=testCaseResults[i],testCase=tcResult.get("TestCase"),void 0!==testCase&&(id=testCase.FormattedID,void 0===id&&(id="No Test Case"),testCaseHolder.hasOwnProperty(id)||(testCaseHolder[id]={TestCase:testCase,results:[]}),testCaseHolder[id].results.push(tcResult));return testCaseHolder},_ascendingOrderedTestCases:function(testCaseHolder){var testCases=[],formattedID;for(formattedID in testCaseHolder)testCaseHolder.hasOwnProperty(formattedID)&&testCases.push(formattedID);return testCases.sort(),testCases},_onTestCasesDataLoaded:function(store,data){if(1>data.length)this.down("#mainHeader").update(""),this.down("#testCaseGrids").add(Ext.create("Ext.container.Container",{html:"No Test Case information found for the current workspace, project and time scale",cls:"error404"}));else for(var testCaseHolder=this._organizeResultsByTestCase(data),testCases=this._ascendingOrderedTestCases(testCaseHolder),records,customStore,tcFormattedID,testCase,testCaseResults,tcLinkTemplate=new Ext.Template('<a href="{targeturl}" target="_top">{id}: {name}</a> {wplink}'),wpLinkTemplate=new Ext.Template(' (<a href="{wptarget}" target="_top">{wptext}</a>)'),i=0;testCases.length>i;i++){records=[];var wpLink="",tcTitle="";tcFormattedID=testCases[i],testCase=testCaseHolder[tcFormattedID].TestCase;var targetUrl=Rally.nav.Manager.getDetailUrl(testCase),ID=testCases[i],name=testCase.Name;if(void 0!==testCase.WorkProduct&&null!==testCase.WorkProduct){var wpTarget=Rally.nav.Manager.getDetailUrl(testCase.WorkProduct),wpText=testCase.WorkProduct.FormattedID+": "+testCase.WorkProduct.Name;wpLink=wpLinkTemplate.apply({wptarget:wpTarget,wptext:wpText})}var testCaseTitle=tcLinkTemplate.apply({targeturl:targetUrl,id:ID,name:name,wplink:wpLink});this.down("#testCaseGrids").add(Ext.create("Ext.container.Container",{html:testCaseTitle,cls:"gridTitle"})),testCaseResults=testCaseHolder[tcFormattedID].results;for(var that=this,j=0;testCaseResults.length>j;j++)records.push({ID:'<a href="'+Rally.nav.Manager.getDetailUrl(that._conditionalGet(testCaseResults[j],"_ref"))+'" target="_top">'+that._conditionalGet(testCaseResults[j],"ObjectID")+"</a>",Build:testCaseResults[j].get("Build"),DateandTime:testCaseResults[j].get("Date"),Verdict:that._drawBox(testCaseResults[j].get("Verdict")),Tester:that._testerIfKnown(testCaseResults[j].get("Tester"))});customStore=Ext.create("Rally.data.custom.Store",{data:records,pageSize:records.length}),this._buildGrid(customStore)}},_buildGrid:function(store){this.down("#testCaseGrids").add(Ext.create("Ext.container.Container",{layout:"fit",cls:"gridContainer",items:{xtype:"rallygrid",store:store,cls:"testCaseGrid",showPagingToolbar:!1,columnCfgs:[{text:"ID",dataIndex:"ID",cls:"columnHeader",flex:2},{text:"Verdict",dataIndex:"Verdict",cls:"columnHeader",width:100},{text:"Build",dataIndex:"Build",cls:"columnHeader",flex:2},{text:"Date and Time",dataIndex:"DateandTime",cls:"columnHeader",flex:3},{text:"Tester",dataIndex:"Tester",cls:"columnHeader",flex:2}]}}))},getOptions:function(){return[{text:"Print",handler:this._onButtonPressed,scope:this}]},_onButtonPressed:function(){var title="Test Case Pass-Fail History",options,css=document.getElementsByTagName("style")[0].innerHTML;options="toolbar=1,menubar=1,scrollbars=yes,scrolling=yes,resizable=yes,width=1000,height=500";var printWindow;printWindow=Ext.isIE?window.open():window.open("","",options);var doc=printWindow.document,grids=this.down("#testCaseGrids"),header=this.down("#mainHeader");doc.write("<html><head><style>"+css+"</style><title>"+title+"</title>"),doc.write('</head><body class="landscape">'),doc.write(header.getEl().dom.innerHTML),doc.write(grids.getEl().dom.innerHTML),doc.write("</body></html>"),doc.close(),this._injectCSS(printWindow),printWindow.print()},_injectContent:function(html,elementType,attributes,container,printWindow){elementType=elementType||"div",container=container||printWindow.document.getElementsByTagName("body")[0];var element=printWindow.document.createElement(elementType);return Ext.Object.each(attributes,function(key,value){"class"===key?element.className=value:element.setAttribute(key,value)}),html&&(element.innerHTML=html),container.appendChild(element)},_injectCSS:function(printWindow){Ext.each(Ext.query("link"),function(stylesheet){this._injectContent("","link",{rel:"stylesheet",href:stylesheet.href,type:"text/css"},printWindow.document.getElementsByTagName("head")[0],printWindow)},this)}});

            Rally.launchApp('CustomApp', {
                name:"TestCasePassFailHistory",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
    margin:5px;
}
.header {
    font-size: 20px;
    margin: 10px;
}
.pass-legend {
    background: #B2E3B6 none repeat scroll 0%; /* std Rally muted green */
    border: 1px solid #DDDDDD;
    color: black;
    cursor: default;
    text-align: center;
}

.pass-legend-other {
    background: #fbde98; /* std Rally muted yellow/tan */
    border: 1px solid #DDDDDD;
    color: black;
    cursor: default;
    text-align: center;
}

.pass-legend-fail {
    background: #fCB5B1 none repeat scroll 0%; /* std Rally muted red */
    border: 1px solid #DDDDDD;
    color: black;
    cursor: default;
    text-align: center;
}

.columnHeader {
    font-weight: bold;
}
.error404 {
    margin: 5px;
    text-align: center;
}
.gridTitle {
    margin: 20px 5px 5px;
    font-weight: bold;
}
.gridContainer {
    padding: 5px;
    margin-left: 20px;
    padding-left: 10px;
    border-left: 3px solid #DDDDDD;
}
.testCaseGrid {
    border-left: 1px solid #C5C5C5;
}
    </style>
</head>
<body></body>
</html>
